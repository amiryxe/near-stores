<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="favicon.svg" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vite App</title>

  <link rel="stylesheet" href="https://cdn.map.ir/web-sdk/1.4.2/css/mapp.min.css">
  <link rel="stylesheet" href="https://cdn.map.ir/web-sdk/1.4.2/css/fa/style.css">
</head>

<body>
  <div id="map" style="width: 100%; height: 450px; background: #eee; border: 2px solid #aaa;"></div>

  <script type="text/javascript" src="https://cdn.map.ir/web-sdk/1.4.2/js/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="https://cdn.map.ir/web-sdk/1.4.2/js/mapp.env.js"></script>
  <script type="text/javascript" src="https://cdn.map.ir/web-sdk/1.4.2/js/mapp.min.js"></script>


  <script>
    $(document).ready(function () {
      function distance(lat1, lon1, lat2, lon2, unit) {
        var radlat1 = Math.PI * lat1 / 180
        var radlat2 = Math.PI * lat2 / 180
        var theta = lon1 - lon2
        var radtheta = Math.PI * theta / 180
        var dist = Math.sin(radlat1) * Math.sin(radlat2) + Math.cos(radlat1) * Math.cos(radlat2) * Math.cos(radtheta);
        if (dist > 1) {
          dist = 1;
        }
        dist = Math.acos(dist)
        dist = dist * 180 / Math.PI
        dist = dist * 60 * 1.1515
        if (unit == "K") { dist = dist * 1.609344 }
        if (unit == "N") { dist = dist * 0.8684 }
        return dist
      }

      var app = new Mapp({
        element: '#map',
        presets: {
          latlng: {
            lat: 32,
            lng: 52,
          },
          zoom: 8,
        },
        apiKey: 'eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImp0aSI6ImVhOWE4M2IyYmM2MDMwN2M1NTdlYmZhMGRiNmViOTljZTkyZDlkOTg4NmI0ZjFjYjI4ZmJjNjBlYzdlMmFlMzI0NjE2ZWJkOTA3OWQ2YTM4In0.eyJhdWQiOiIxODY0MCIsImp0aSI6ImVhOWE4M2IyYmM2MDMwN2M1NTdlYmZhMGRiNmViOTljZTkyZDlkOTg4NmI0ZjFjYjI4ZmJjNjBlYzdlMmFlMzI0NjE2ZWJkOTA3OWQ2YTM4IiwiaWF0IjoxNjU3MDg4MjA0LCJuYmYiOjE2NTcwODgyMDQsImV4cCI6MTY1OTY4MDIwNCwic3ViIjoiIiwic2NvcGVzIjpbImJhc2ljIl19.Pxtx8REKmGNZvYkknWcmkUgnvMQtRCw2HYyO1cKmyUvzNtiio2zsxIWDerH1o6jWH17BmnE2XHWXBhOT5NRkrFXKU2HJS-QXOeCDacUn_qwsLB5hHFs5m60wLErifL9o1RXcT8xg70RXQnBzJsW1qu0pr1GDub_RlF3bZj0GdDYxXHGgoWP1LKNloJy6lZU1j2cDgWIEKHurGall1oxaHEiJNDitQxIMbIyQ8z8XEs6fBh2EkU2XSezW9UP3gGRxR_kLk2ObbBr92fv9GGzIxSauA10QWCWb6ELogVcn_rO5jNGTmh14eeKnEZ0Cb8i6pXOXZ9vbHJzzRwIL-7qJkg'
      });

      app.addVectorLayers();

      app.addGeolocation({
        // history: true,
        onLoad: true,
        onLoadCallback: async function () {
          const res = await fetch('./chains.json')
          const storeList = await res.json()

          storeList.data.map(item => {
            if (distance(app.states.user.latlng.lat, app.states.user.latlng.lng, Number(item.lat), Number(item.lng), "K") <= 4) {
              const marker = app.addMarker({
                name: item.name,
                popup: {
                  title: {
                    html: item.name,
                    i18n: '',
                  },
                  description: {
                    html: item.address,
                    i18n: '',
                  },
                },
                latlng: {
                  lat: item.lat,
                  lng: item.lng,
                },
                popupOpen: true,
              });
            }
          })
        },
      });



      // var markers = L.markerClusterGroup({ chunkedLoading: true });
    });
  </script>

  <div id="app"></div>
  <script type="module" src="/main.js"></script>
</body>

</html>