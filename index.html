<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="favicon.svg" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vite App</title>

  <link rel="stylesheet" href="https://cdn.map.ir/web-sdk/1.4.2/css/mapp.min.css">
  <link rel="stylesheet" href="https://cdn.map.ir/web-sdk/1.4.2/css/fa/style.css">
</head>

<body>
  <div id="map" style="width: 100%; height: 450px; background: #eee;"></div>
  <button id="find_me">find me</button>
  <select name="" id="provinces">
    <option value="-1" selected disabled>انتخاب استان</option>
  </select>
  <select name="" id="cities"></select>
  <p></p>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"
    integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ=="
    crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"
    integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ=="
    crossorigin=""></script>
  <script src="./leaflet-wms-header.js"></script>

  <script>
    function distance(lat1, lon1, lat2, lon2, unit) {
      var radlat1 = Math.PI * lat1 / 180
      var radlat2 = Math.PI * lat2 / 180
      var theta = lon1 - lon2
      var radtheta = Math.PI * theta / 180
      var dist = Math.sin(radlat1) * Math.sin(radlat2) + Math.cos(radlat1) * Math.cos(radlat2) * Math.cos(radtheta);
      if (dist > 1) {
        dist = 1;
      }
      dist = Math.acos(dist)
      dist = dist * 180 / Math.PI
      dist = dist * 60 * 1.1515
      if (unit == "K") { dist = dist * 1.609344 }
      if (unit == "N") { dist = dist * 0.8684 }
      return dist
    }


    // Get data
    (async function () {
      var map = L.map('map').setView([32, 51], 8);

      L.TileLayer.wmsHeader('https://map.ir/shiveh', {
        layers: "Shiveh:Shiveh",
        format: 'image/png',
        transparent: true,
        attribution: '© OpenStreetMap'
      },
        [
          {
            header: "x-api-key",
            value: "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImp0aSI6ImVhOWE4M2IyYmM2MDMwN2M1NTdlYmZhMGRiNmViOTljZTkyZDlkOTg4NmI0ZjFjYjI4ZmJjNjBlYzdlMmFlMzI0NjE2ZWJkOTA3OWQ2YTM4In0.eyJhdWQiOiIxODY0MCIsImp0aSI6ImVhOWE4M2IyYmM2MDMwN2M1NTdlYmZhMGRiNmViOTljZTkyZDlkOTg4NmI0ZjFjYjI4ZmJjNjBlYzdlMmFlMzI0NjE2ZWJkOTA3OWQ2YTM4IiwiaWF0IjoxNjU3MDg4MjA0LCJuYmYiOjE2NTcwODgyMDQsImV4cCI6MTY1OTY4MDIwNCwic3ViIjoiIiwic2NvcGVzIjpbImJhc2ljIl19.Pxtx8REKmGNZvYkknWcmkUgnvMQtRCw2HYyO1cKmyUvzNtiio2zsxIWDerH1o6jWH17BmnE2XHWXBhOT5NRkrFXKU2HJS-QXOeCDacUn_qwsLB5hHFs5m60wLErifL9o1RXcT8xg70RXQnBzJsW1qu0pr1GDub_RlF3bZj0GdDYxXHGgoWP1LKNloJy6lZU1j2cDgWIEKHurGall1oxaHEiJNDitQxIMbIyQ8z8XEs6fBh2EkU2XSezW9UP3gGRxR_kLk2ObbBr92fv9GGzIxSauA10QWCWb6ELogVcn_rO5jNGTmh14eeKnEZ0Cb8i6pXOXZ9vbHJzzRwIL-7qJkg"
          }
        ])
        .addTo(map);

      // map.on('zoomend', function (e) {
      //   console.log(map.getZoom());
      //   if (map.getZoom() < 7) {
      //     map.setZoom(7);
      //   }
      // });

      var markerGroup = L.layerGroup().addTo(map);

      const res = await fetch('./chains.json')
      const storeList = await res.json()

      console.log(storeList)

      const resPlaces = await fetch('./city.json')
      const places = await resPlaces.json()

      const groupBy = function (xs, key) {
        return xs.reduce(function (rv, x) {
          (rv[x[key]] = rv[x[key]] || []).push(x);
          return rv;
        }, {});
      };

      const groupedPlaces = groupBy(places, 'state')

      // render list of provinces
      Object.keys(groupedPlaces).sort().map(item => {
        document.querySelector('#provinces').insertAdjacentHTML('beforeend', `<option value="${item}">${item}</option>`)
      })

      // render list of cities on province change
      document.querySelector('#provinces').addEventListener('change', async e => {
        markerGroup.clearLayers();
        document.querySelector('#cities').innerHTML = ''

        console.log(groupedPlaces[e.target.value])

        // render city options to select
        groupedPlaces[e.target.value].map(item => {
          document.querySelector('#cities').insertAdjacentHTML('beforeend', `<option value="${item.city}">${item.city}</option>`)
        })

        // render markers on province change
        const arr = storeList.data.map(item => {
          if (item.state === e.target.value) {
            const marker = L.marker([item.lat, item.lng]).addTo(markerGroup);
            marker.bindPopup(`<h3>${item.name}</h3><p>${item.address}</p>`);
            return [item.lat, item.lng]
          }
        }).filter(item => (item !== undefined)).filter(item => item.join() != '0,0')

        map.fitBounds(arr);
      })

      // render markers on city change
      document.querySelector('#cities').addEventListener('change', async e => {
        markerGroup.clearLayers();

        console.log(e.target.value)

        const arr = storeList.data.map(item => {
          if (item.city === e.target.value) {
            const marker = L.marker([item.lat, item.lng]).addTo(markerGroup);
            marker.bindPopup(`<h3>${item.name}</h3><p>${item.address}</p>`);
            return [item.lat, item.lng]
          }
        }).filter(item => (item !== undefined)).filter(item => item.join() != '0,0')

        map.fitBounds(arr);
      })

      function onLocationFound(e) {
        L.marker(e.target.getCenter()).addTo(markerGroup).bindPopup("موقعیت شما").openPopup();

        map.flyTo(e.latlng, 13);

        storeList.data.map(item => {
          if (distance(e.latlng.lat, e.latlng.lng, Number(item.lat), Number(item.lng), "K") <= map.getZoom() / 3) {
            var marker = L.marker([item.lat, item.lng]).addTo(markerGroup).bindPopup(item.name)
          }
        })
      }

      map.on('locationfound', onLocationFound);

      map.locate({
        setView: true,
        maxZoom: 13,
      })

      document.querySelector('#find_me').addEventListener('click', function () {
        map.locate({
          setView: true,
          maxZoom: 13,
        })
      })


      map.on('dragend', async function (e) {
        markerGroup.clearLayers();

        const { lat, lng } = e.target.getCenter();

        L.marker(e.target.getCenter()).addTo(markerGroup).bindPopup("فروشگاه‌ها از اینجا").openPopup();

        storeList.data.map(item => {
          if (distance(lat, lng, Number(item.lat), Number(item.lng), "K") <= map.getZoom() / 3) {
            var marker = L.marker([item.lat, item.lng]).addTo(markerGroup).bindPopup(item.name)
          }
        })
      });
    })()
  </script>

  <div id="app"></div>
  <script type="module" src="/main.js"></script>
</body>

</html>